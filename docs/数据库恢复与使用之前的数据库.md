# 使用之前的数据库 / 加载失败排查

## 确认 admin / admin123 是否可用

项目里**只有一个**数据库文件：**`Counting Helper\database\accounting.db`**（已在正确位置）。

若你希望用**用户名 admin、密码 admin123** 登录，可先运行一次「确保 admin 用户」工具（会检查该库是否有 admin，没有则创建，密码不对则改为 admin123）：

- 在 **`backend-java`** 目录下双击运行 **`ensure-admin.bat`**  
  或在该目录打开命令行执行：  
  `mvn -q compile exec:java "-Dexec.mainClass=com.countinghelper.tools.EnsureAdminUser"`

- 若输出 **`OK: User 'admin' already exists and password is admin123`** 或 **`OK: Created/Updated user 'admin'`**，说明当前 `database\accounting.db` 已支持 admin/admin123 登录，无需再移动文件。

---

## 先看启动时的两行日志

重新运行 **`backend-java/start.bat`** 后，在黑色窗口里会看到类似：

```
[INFO] Database: C:\...\Counting Helper\database\accounting.db
[DB] Resolved path: ...
[DB] File exists: yes, size: ... bytes
```

- 若 **File exists: NO**：说明当前用的路径下没有 `accounting.db`，请按下面「一」把备份放到该路径，或设置 `DB_PATH`。
- 若 **File exists: yes** 但网页仍「加载失败」：多半是表结构和当前代码不一致，看同一窗口里的**红色报错**（SQL 或 Exception），或按下面「二」排查。

---

## 一、如何用回之前的数据库文件

1. **找到你的备份**  
   把你之前能用的 `accounting.db` 文件准备好（例如从备份或旧电脑拷出来）。

2. **放到项目里（推荐）**  
   - 在项目根目录下要有 **`database`** 文件夹（与 `backend-java`、`frontend` 同级）。  
   - 把你的 **`accounting.db`** 放进去，最终路径为：  
     **`Counting Helper/database/accounting.db`**

3. **若使用 SQLite 的 WAL 模式**  
   - 如果目录里还有 `accounting.db-shm`、`accounting.db-wal`，先**关掉所有正在用这个数据库的程序**（包括后端、DB 工具）。  
   - **只恢复主文件**时：可以只复制 `accounting.db` 到 `database/`，**不要**把旧的 `-shm`、`-wal` 一起拷过去（或先删掉再启动），避免“数据库被锁定”或异常。

4. **用自定义路径（可选）**  
   - 不想改项目里的 `database` 文件夹时，可以指定绝对路径。  
   - **方式 A**：启动前设置环境变量（PowerShell 示例）：  
     `$env:DB_PATH="C:\你的路径\accounting.db"`  
     然后再运行 `start.bat`。  
   - **方式 B**：在 `backend-java` 目录执行：  
     `java -Ddb.path=C:/你的路径/accounting.db -jar target/counting-helper-backend-1.0.0.jar`

5. **重启后端**  
   - 关闭当前后端窗口，重新双击 **`backend-java/start.bat`**。  
   - 看窗口里 **`[INFO] Database:`** 和 **`[DB] File exists:`** 两处，确认路径和文件是否存在，再刷新浏览器。

---

## 二、页面显示“加载失败”时怎么查

“加载失败”不一定是数据库损坏，常见原因有：

| 情况 | 处理 |
|------|------|
| **后端没启动** | 先运行 `backend-java/start.bat`，等出现 `Started CountingHelperApplication` 再访问页面。 |
| **数据库路径不对** | 确认 `database/accounting.db` 在项目根下的 `database` 文件夹里；或用上面的 `DB_PATH` / `-Ddb.path` 指定你备份的路径。 |
| **数据库被占用** | 关掉其他打开该 DB 的程序（如 DB 浏览器、旧的后端窗口），删除同目录下的 `accounting.db-shm`、`accounting.db-wm` 后重启后端。 |
| **表结构和当前代码不一致** | 若备份是很早的版本，表名或字段可能对不上，后端会报错。看后端控制台报错；必要时用当前版本先跑出一个新库，再对照结构或迁移数据。 |

**看具体错误信息：**  
- 页面上“加载失败”下方会显示简短原因（如“网络异常”“服务器错误”），并有一个 **「重试」** 按钮。  
- 后端控制台会打印详细异常（例如 SQL 错误、文件找不到），根据提示排查。

---

## 三、确认数据库是否损坏

- 用 [DB Browser for SQLite](https://sqlitebrowser.org/) 或类似工具打开 `accounting.db`，能正常打开、能查表，一般说明文件没坏。  
- 若工具报“database disk image is malformed”等，才考虑文件损坏，需用备份或从备份恢复。

按上面步骤操作后，再访问 http://localhost:8000 并点一次「重试」，通常就能用回之前的数据库并正常显示。
