# 并发性能优化说明

## 📋 修改的文件列表

### 后端文件

1. **`server/index.js`** - 主要优化文件
   - 启用SQLite WAL模式（支持并发读写）
   - 添加数据库性能优化配置
   - 添加数据库查询队列管理
   - 添加性能监控中间件
   - 添加性能监控API (`/api/performance`)
   - 优化服务器启动和关闭流程
   - 添加数据库索引

2. **`server/package.json`** - 添加测试脚本
   - 添加 `load-test` 和 `test` 脚本

3. **`server/load_test.js`** - 新建压力测试工具
   - 支持并发用户模拟
   - 自动统计性能指标
   - 估算最大并发用户数

### 前端文件

4. **`frontend/src/pages/Performance.tsx`** - 新建性能监控页面
   - 实时显示服务器性能指标
   - 支持自动刷新
   - 显示响应时间统计（P50, P95, P99）
   - 显示数据库连接状态

5. **`frontend/src/services/api.ts`** - 添加性能API
   - 添加 `performanceApi.getStats()` 方法

6. **`frontend/src/App.tsx`** - 添加性能监控路由
   - 添加 `/performance` 路由

7. **`frontend/src/components/Layout.tsx`** - 添加性能监控入口
   - 在导航栏添加"性能监控"链接（仅管理员可见）

### 工具文件

8. **`压力测试.bat`** - 新建压力测试启动脚本
   - 一键运行压力测试

9. **`并发优化说明.md`** - 本文档

## ⚡ 优化内容

### 1. 数据库优化

- **WAL模式（Write-Ahead Logging）**
  - 支持多个读操作和一个写操作同时进行
  - 大幅提高并发性能

- **性能配置**
  - `PRAGMA synchronous = NORMAL` - 平衡性能和安全性
  - `PRAGMA cache_size = -10000` - 10MB缓存
  - `busyTimeout = 5000ms` - 忙等待超时

- **数据库索引**
  - `idx_transactions_user_id` - 用户ID索引
  - `idx_transactions_created_at` - 日期索引
  - `idx_transactions_type` - 交易类型索引
  - `idx_users_username` - 用户名索引
  - `idx_users_role` - 角色索引

### 2. 查询队列管理

- 最大并发查询数：50
- 自动队列管理，防止数据库过载
- 智能调度查询请求

### 3. 性能监控

- 实时请求统计
- 响应时间监控（平均、P50、P95、P99）
- 错误率统计
- 数据库连接状态监控
- RPS（每秒请求数）计算

### 4. 服务器优化

- 请求体大小限制：10MB
- 性能监控中间件
- 优雅关闭处理

## 🧪 压力测试

### 使用方法

1. 确保服务器正在运行
2. 运行 `压力测试.bat` 或执行：
   ```bash
   cd server
   node load_test.js
   ```

### 测试配置

- 并发用户数：10
- 每用户请求数：20
- 总请求数：200
- 测试端点：健康检查、统计、交易列表

### 测试结果说明

测试完成后会显示：
- 总请求数和成功率
- 平均响应时间
- P50、P95、P99响应时间
- 估算的最大并发用户数
- 建议的安全并发用户数

## 📊 性能监控

### 访问方式

1. 使用管理员账户登录
2. 点击导航栏中的"性能监控"
3. 或直接访问：`http://localhost:3000/performance`

### 监控指标

- **运行时间** - 服务器运行时长
- **总请求数** - 累计处理的请求数
- **当前并发** - 当前正在处理的请求数
- **峰值并发** - 历史最高并发数
- **请求/秒** - 每秒处理的请求数
- **响应时间** - 平均、P50、P95、P99
- **错误统计** - 错误总数和错误率
- **数据库状态** - 活跃连接、队列长度

## 💡 性能建议

根据测试结果，系统可以支持：
- **估计最大并发用户数**：基于测试结果计算
- **建议并发用户数**：最大值的70%（安全值）

## 🔧 进一步优化建议

1. **如果并发需求更高**：
   - 考虑使用PostgreSQL或MySQL替代SQLite
   - 使用Redis缓存热点数据
   - 实现数据库读写分离

2. **如果响应时间需要优化**：
   - 添加API响应缓存
   - 优化数据库查询语句
   - 使用CDN加速静态资源

3. **如果稳定性需要提升**：
   - 添加请求限流（rate limiting）
   - 实现负载均衡
   - 添加健康检查和自动重启
